<META HTTP-EQUIV="EXPIRES" CONTENT= 0>
<title> PixelPeople </title>
<link href='http://fonts.googleapis.com/css?family=VT323' rel='stylesheet'
  type='text/css'>
<style>
  body{
    background-image:url('assets/testBrick.png');
    background-repeat: repeat;
    margin: 0;
    font-family: 'VT323', sans-serif;
    font-size: 2em;
  }
  
  #player{
    position: absolute;
    left: 50%;
    margin-left:-28px;
    height: 100px;
    top: 50%;
    margin-top: -37.5px;
    z-index: 1000;
    transition:.02s linear;
    }
  .NPC{
    position: absolute;
    height: 100px;
    z-index: 0;
    display: none;
  }
  #textBox{
    position: absolute;
    bottom: 0;
    background-color: white;
    height: 100px;
    margin: 10px;
    padding: 5px;
    outline: solid;
    outline-width: 1px;
    outline-color: #444;
    z-index: 1000000;
  }
  #title{
    display: none;
    position: absolute;
    margin-left: 50%;
    left: -200px;
    z-index: 10000000000;
  }
</style>

<body id="container">

<div id="fb-root"></div>

  <script>
    var title;
    window.fbAsyncInit = function() {
      // init the FB JS SDK
      FB.init({
        appId      : 509402089096990,                        // App ID from the app dashboard
        status     : true,                                 // Check Facebook Login status
        xfbml      : true                                  // Look for social plugins on the page
      });
      console.log('api loaded!');
      FB.getLoginStatus(function(response) {
        if(response.status != 'connected'){
          FB.login(function(response){}, {scope:"read_stream, publish_actions"});
        }
      })
      title = document.createElement('img');
      title.setAttribute('src', 'assets/Title.png');
      title.id = "title";
      document.getElementById('container').appendChild(title);
      $(title).fadeIn("slow");
      // read_stream initialization code such as adding Event Listeners goes here
    };

    // Load the SDK asynchronously
    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "http://connect.facebook.net/en_US/all.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

  <img id = "player" face = "north" src = 'assets/Player0000.png'></img>
<audio style = "display: none" controls autoplay loop= "loop" autoplay = "autoplay"> <source src="assets/bgm.mp3" type="audio/mpeg"></audio>
</body>

<script src="jquery-1.9.1.js"></script>

<script>

  var player = document.getElementById('player');
  var idlep = setInterval(function() {animate(player)}, 500);
  var NPCs = document.getElementsByClassName('NPC');
  var box;
  var closest; 
  var headings = ['west', 'east', 'north', 'south'];
  var posts = [];
  function square(x){return Math.pow(x, 2);};
  function animate(object){
    var heading = object.getAttribute("face");
    if(heading == "south" || heading == "north"){
      if (object.getAttribute("src") == 'assets/NPC0000.png') {
        object.setAttribute("src", 'assets/NPC0001.png');
      } else if (object.getAttribute("src") == 'assets/NPC0001.png') {
        object.setAttribute("src",'assets/NPC0000.png');
      } else if (object.getAttribute('class') == "NPC"){
        object.setAttribute("src", 'assets/NPC0000.png');
      }
      else if (object.getAttribute("src") == 'assets/Player0000.png') {
        object.setAttribute("src", 'assets/Player0001.png');
      } else if (object.getAttribute("src") == 'assets/Player0001.png') {
        object.setAttribute("src",'assets/Player0000.png');
      } else {
        object.setAttribute("src", 'assets/Player0000.png');}
    }

    if(heading == "west" || heading == "east"){
      if (object.getAttribute("src") == 'assets/NPCSide0000.png') {
        object.setAttribute("src", 'assets/NPCSide0001.png');
      } else if (object.getAttribute("src") == 'assets/NPCSide0001.png') {
        object.setAttribute("src",'assets/NPCSide0000.png');
      } else if (object.getAttribute('class') == "NPC"){
        object.setAttribute("src", 'assets/NPCSide0000.png');
      } else if (object.getAttribute("src") == 'assets/PlayerSide0000.png') {
        object.setAttribute("src", 'assets/PlayerSide0001.png');
      } else if (object.getAttribute("src") == 'assets/PlayerSide0001.png') {
        object.setAttribute("src",'assets/PlayerSide0000.png');
      } else {object.setAttribute("src", 'assets/PlayerSide0000.png');}
    }
  }
  var idleN = setInterval(function() {
    for (var i = 0; i < NPCs.length; i++){
      NPCs[i].style.zIndex = $(NPCs[i]).position().top -50;
      player.style.zIndex = $(player).position().top;
      animate(NPCs[i]);
    }
  }, 500);
  var currentPost;
  $(document.body).keydown(function(event){
    var interval = 10
    if(event.keyCode != 123){
      event.preventDefault();
    }
    var pos = $(player).position();
    var keyPress = event.keyCode
    if (box != undefined && box.innerHTML == 'Like post? Y/N.'){ 
      if (keyPress == 89){
        FB.api("/"+currentPost+"/likes", 'post', function(response){
          console.log(response);
          if(response == true){
            console.log("success");
            box.innerHTML = "'And so it shall be.'"
          }
        })
        return;
      }
      else if (keyPress == 78){
        removeBox();
      }
      return;
    }
    else if(keyPress == 39){
      player.setAttribute("face", "east"); 
      animate(player);
      player.style.left = interval + pos.left;
    }
    else if(keyPress == 37){
      player.setAttribute("face", "west"); 
      animate(player);
      player.style.left = pos.left - interval;
    }
    else if(keyPress == 40){
      player.setAttribute("face", "south");
      animate(player);
      player.style.top = interval + pos.top;
    }
    else if(keyPress == 38){
      player.setAttribute("face", "north")
      animate(player);
      player.style.top = pos.top - interval;
    }
    else if(keyPress == 32){
      if (title != undefined){
        $(title).fadeOut("slow");
        populate();
        setTimeout(function(){populate();}, 3000);
        title = undefined;
        return;
      }
      if (box != undefined){
        if (box.innerHTML == "'And so it shall be.'"){
          removeBox();
          return;
        }
        box.innerHTML = 'Like post? Y/N.';
        return;
        //removeBox();
      }
      var heading = player.getAttribute("face");
      var closestDist = 100000000;
      for (var i = 0; i < NPCs.length; i++){
        var nPos = $(NPCs[i]).position();
        if (nPos.left >= pos.left && heading =="west"){
          continue;
        }
        if (nPos.top >= pos.top && heading =="north"){
          continue;
        }
        if (nPos.top <= pos.top && heading =="south"){
          continue;
        }
        if (nPos.left <= pos.left && heading =="east"){
          continue;
        }
        var dist = Math.sqrt(square(nPos.left-pos.left)+square((nPos.top*1.32)
                   -(pos.top*1.32)));
        console.log(dist);
        if (dist <= 100){
          if (dist < closestDist){
            closest = i;
          }
        }
      }
      if(closest != undefined){
        box = document.createElement('div');
        box.id = 'textBox';
        box.style.width = window.innerWidth-30;
        var name;
        if (posts.length == 0){
          FB.api('me/home?until=now&fields=message', function(response){
            console.log(response);
            posts = response.data;
            writeBox();
          });
        }
        else{
          writeBox();
          closest = undefined;
        }
      }
    }
  });
  function writeBox(){
    var curr = posts.shift();
    while (curr.message == undefined){
      curr = posts.shift();
    }
    currentPost = curr.id;
    box.innerHTML = curr.message;
    document.getElementById('container').appendChild(box);
    return;
  }
  function removeBox(){
    box.remove();
    box = undefined;
    $(NPCs[closest]).fadeTo('fast', 0, function(){NPCs[closest].remove()});
    makePerson();
    currentPost = undefined;
    return;
  }
  function makePerson(){
    var person = document.createElement('img');
    person.setAttribute("class", "NPC");  
    person.style.left = Math.round((Math.random()*(window.innerWidth-51))/51)*51;
    person.style.top = Math.round((Math.random()*(window.innerHeight-51))/51)*51;
    person.setAttribute("face", headings[Math.floor((Math.random()*4))]);
    document.getElementById("container").appendChild(person);
    $(person).fadeIn("slow");  
  }

  function populate(){
    setTimeout(function(){
        setTimeout(function(){
          makePerson();
            setTimeout(function(){
              makePerson();
              setTimeout(function(){
                makePerson();
                setTimeout(function(){
                  makePerson();
                  setTimeout(function(){
                    makePerson();
                  }, 500)
                }, 500)
              }, 500)
            }, 500)
        }, 500)
      }, 0);
  }
</script>